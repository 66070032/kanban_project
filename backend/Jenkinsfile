pipeline {
    agent any

    environment {
        SSH_CRED_ID   = 'SSH_SV_01'
        REMOTE_IP     = '192.168.1.200'
        REMOTE_USER   = 'root'
        APP_NAME      = 'kanban-api'
        // ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á Server
        TARGET_DIR    = "~/kanban-api/backend"
        DATABASE_URL  = credentials('KANBAN_DB')
    }

    stages {
        stage('Deploy Backend') {
            steps {
                // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏ä‡πâ dir('backend') ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Jenkins ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå backend
                dir('backend') {
                    sshagent([env.SSH_CRED_ID]) {
                        echo "Working in: ${pwd()}" // ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á path ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /backend

                        // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á
                        sh "ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_IP} 'mkdir -p ${TARGET_DIR}'"

                        // 2. ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á Jenkins (‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå backend) ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á
                        // . ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô kanban_project/backend/
                        sh "rsync -avz --delete --exclude 'node_modules' --exclude '.git' ./ ${REMOTE_USER}@${REMOTE_IP}:${TARGET_DIR}"

                        // 3. ‡∏™‡∏±‡πà‡∏á Build ‡πÅ‡∏•‡∏∞ Run ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á
                        sh """
                            ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_IP} '
                                cd ${TARGET_DIR} && \
                                echo "üî® Building Image..." && \
                                docker build -t ${APP_NAME} . && \
                                
                                echo "üõë Removing old container..." && \
                                docker rm -f ${APP_NAME} || true && \
                                
                                echo "üöÄ Starting Container..." && \
                                docker run -d \
                                    --name ${APP_NAME} \
                                    -p 3000:3000 \
                                    --restart always \
                                    ${APP_NAME}
                            '
                        """
                    }
                }
            }
        }
    }
}